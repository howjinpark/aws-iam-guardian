name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *'  # 매일 오전 2시 실행

env:
  REGISTRY: ghcr.io

jobs:
  # 통합 테스트
  integration-test:
    name: 마이크로서비스 통합 테스트
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: integration_test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
        options: >-
          --health-cmd pg_isready -U test_user -d integration_test_db
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
      
      - name: 필수 도구 설치
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      
      - name: Docker Compose 설정
        run: |
          # 통합 테스트용 docker-compose 파일 생성
          cat > docker-compose.test.yml << 'EOF'
          version: '3.8'
          services:
            auth-service:
              build: 
                context: ./services/auth-service
                dockerfile: Dockerfile
              environment:
                - DATABASE_URL=postgresql://test_user:test_pass@host.docker.internal:5432/integration_test_db
                - SECRET_KEY=test-secret-key-for-integration-test
                - DEBUG=true
                - HOST=0.0.0.0
                - PORT=8000
              ports:
                - "8000:8000"
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 20s
            
            iam-manager:
              build: 
                context: ./services/iam-manager
                dockerfile: Dockerfile
              environment:
                - DATABASE_URL=postgresql://test_user:test_pass@host.docker.internal:5432/integration_test_db
                - AUTH_SERVICE_URL=http://auth-service:8000
                - AWS_ACCESS_KEY_ID=testing
                - AWS_SECRET_ACCESS_KEY=testing
                - AWS_DEFAULT_REGION=us-east-1
                - DEBUG=true
                - HOST=0.0.0.0
                - PORT=8001
              ports:
                - "8001:8001"
              depends_on:
                auth-service:
                  condition: service_healthy
              extra_hosts:
                - "host.docker.internal:host-gateway"
              healthcheck:
                test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
                interval: 10s
                timeout: 5s
                retries: 5
                start_period: 20s
          EOF
      
      - name: 서비스 시작 및 헬스체크
        run: |
          set -e
          echo "Docker Compose로 서비스 시작..."
          docker compose -f docker-compose.test.yml up -d --build
          
          echo "서비스 헬스체크 대기 중..."
          timeout=300
          elapsed=0
          
          while [ $elapsed -lt $timeout ]; do
            HEALTHS=$(docker compose -f docker-compose.test.yml ps --format json | jq -r '.[].Health')
            if echo "$HEALTHS" | grep -q "healthy"; then
              echo "서비스가 정상적으로 시작되었습니다."
              break
            fi
            echo "서비스 시작 대기 중... ($elapsed/$timeout 초)"
            sleep 10
            elapsed=$((elapsed + 10))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "서비스 시작 타임아웃!"
            docker compose -f docker-compose.test.yml logs
            exit 1
          fi
          
          echo "=== 최종 헬스체크 ==="
          curl -f http://localhost:8000/health && echo "Auth Service: OK"
          curl -f http://localhost:8001/health && echo "IAM Manager: OK"
      
      - name: 통합 테스트 실행
        run: |
          set -e
          echo "=== Auth Service 테스트 ==="
          
          ADMIN_RESPONSE=$(curl -s -f -X POST http://localhost:8000/api/v1/users/init-admin \
            -H "Content-Type: application/json" \
            -d '{"username":"testadmin","password":"TestPass123!"}')
          echo "관리자 생성: $ADMIN_RESPONSE"
          
          LOGIN_RESPONSE=$(curl -s -f -X POST http://localhost:8000/api/v1/auth/login \
            -H "Content-Type: application/json" \
            -d '{"username":"testadmin","password":"TestPass123!"}')
          echo "로그인: $LOGIN_RESPONSE"
          
          TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.access_token')
          if [ -z "$TOKEN" ]; then
            echo "토큰 추출 실패"
            exit 1
          fi
          echo "토큰: $TOKEN"
          
          echo "=== IAM Manager Service 테스트 ==="
          ACCOUNTS_RESPONSE=$(curl -s -f http://localhost:8001/api/v1/accounts/)
          echo "계정 목록: $ACCOUNTS_RESPONSE"
          
          USERS_RESPONSE=$(curl -s -f http://localhost:8001/api/v1/accounts/main/users || echo "AWS Mock 필요")
          echo "사용자 목록: $USERS_RESPONSE"
      
      - name: 로그 수집
        if: failure()
        run: |
          echo "=== Auth Service 로그 ==="
          docker compose -f docker-compose.test.yml logs auth-service
          
          echo "=== IAM Manager 로그 ==="
          docker compose -f docker-compose.test.yml logs iam-manager
      
      - name: 정리
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v

  # 성능 테스트 (현재 비활성화)
  performance-test:
    name: 성능 테스트
    runs-on: ubuntu-latest
    needs: integration-test
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v4
      
      - name: 성능 테스트 스킵
        run: |
          echo "성능 테스트는 현재 비활성화되어 있습니다."
          echo "실제 서비스 배포 후 활성화 예정"
